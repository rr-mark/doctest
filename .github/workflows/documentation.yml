name: Generate and deploy documentation
on:
  push:
    branches: [ master, test ]

jobs:
  generate-documentation:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      # Install Graphviz and Doxygen.
      - name: Install Graphviz and Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install graphviz
          sudo apt-get install doxygen
      
      # Configure git settings.
      - name: Configure git settings
        run: |
          git config --global user.email "mark@rivelinrobotics.com"
          git config --global user.name "Mark Johnson"
      
      # Checkout master branch.
      - uses: actions/checkout@v2
        with:
          repository: ${{ github.repository }}
          ref: master
          path: repository
      
      # Checkout target repository.
      - uses: actions/checkout@v2
        with:
          repository: rr-mark/target
          ref: master
          path: target
          ssh-key: ${{ secrets.TARGET_SSH_PRIVATE_KEY }}
      
      # Clear previous documentation.
      - name: Clear previous documentation
        run: |
          cd target
          git rm -r --ignore-unmatch internal/docs/*
      
      # Run Doxygen.
      - name: Run Doxygen
        run: |
          cd repository
          ( cat internal/docs/Doxyfile ; echo "OUTPUT_DIRECTORY = ../target/internal/docs" ) | doxygen -
      
      # Commit and push changes.
      - name: Commit and push changes
        run: |
          cd target
          git add internal/docs/*
          git commit -m "Automatically updated documentation."
          git push origin master
